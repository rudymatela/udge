#!/bin/bash
#
# Some core utilities.
# To be imported from other Udge scripts.

. /etc/udge/conf

# a sanity check for user and problem names
SANE='^[a-z_][a-z0-9_-]*$'

# a sanity check for emails (needs -E)
# not a full RFC compliant verification, but does the job.
SANE_EMAIL='^[a-z0-9][a-z0-9._%+-]*@[a-z0-9.-]+\.[a-z0-9.-]+$'

errxit() {
	# We use >&2 here instead of /dev/stderr.
	#
	# For some reason I was getting the following error when running scripts
	# from cron:
	#
	#     CROND: (user) CMDOUT (/usr/local/lib/udge/core: line 18: /dev/stderr: Permission denied)
	echo "`basename "$0"`, error: $@" >&2
	exit 1
}

cator1() {
	[ -f "$1" ] && cat $1 || echo 1
}

ls-users() {
	[ -d $USERS ] || errxit "could not find USERS=$USERS"
	find $USERS/ -mindepth 1 -maxdepth 1 -type d | sed -e "s,.*/,," | sort
}

ls-problems() {
	[ -d $PROBLEMS ] || errxit "could not find PROBLEMS=$PROBLEMS"
	find $PROBLEMS/ -mindepth 1 -maxdepth 1 -type d | sed -e "s,.*/,," | sort
}

ls-languages() {
	[ -d $lib/compile ] || errxit "could not find $lib/compile"
	for compiler in `find $lib/compile/ -mindepth 1 -maxdepth 1 | sort`
	do
		language=`echo $compiler | sed -e "s,.*/,,"`
		name=`head -3 $compiler | tail -1 | grep "^# " | sed -e "s/# //"`
		[ -n "$name" ] || name=$language
		printf "%-3s %s\n" $language $name
	done
}

# checks if the given argument is a sane user/problem name
# usage: sane blah123
sane() {
	echo "$1" | grep -q "$SANE"
}

# checks if the given argument is a sane email
# usage: sane user@example.com
sane-email() {
	echo "$1" | grep -qE "$SANE_EMAIL"
}

[ -d "$prefix" ] || errxit "prefix directory ($prefix) does not exist, broken Udge installation?"
bin=$prefix/bin
lib=$prefix/lib/udge
