#!/bin/bash
#
# usage: udge-update-user-html <user> [force]
prefix="$(dirname "$(dirname "$0")")"
. "$prefix/lib/udge/core"
. "$lib/html"
user="$1"
[ -n "$user" ] || errxit "missing <user> argument"
[ -d "$USERS/$user" ] || errxit "user not found"
force="$2"
user_html="$PUBLIC_HTML/u/$user.html"
mkdir -p "$PUBLIC_HTML/u"

set -e

install-bootstrap

doit() {
	tmpfile="$user_html.html"
	[ -e "$tmpfile" ] && errxit "instance still running?  if not, delete '$tmpfile' and try again"
	$lib/user-html "$user" > $tmpfile
	mv $tmpfile $user_html
	echo "`basename $0`: $@"
	exit 0
}

[ ! -e "$user_html" ]                     && doit "created $user_html"
[ "$user_html" -ot "$SUBMISSIONS/$user" ] && doit "updated $user_html (new submissions)"
[ "$user_html" -ot "$RESULTS/$user"  ]    && doit "updated $user_html (new results)"
[ "$force" = force ]                      && doit "updated $user_html (force)"
true
