#!/bin/bash
#
# usage: ./bin/latest-results <user>
. /etc/udge/conf
errxit() {
	echo "$0, error: $@" >/dev/stderr
	echo "usage:" >/dev/stderr
	echo "  $0 <user>" >/dev/stderr
	exit 1
}
user="$1"
submissions="$UNJUDGED_DIR/$user"
results="$RESULTS_DIR/$user"
format() {
	sed -e 's,.*/\([0-9][0-9][0-9][0-9]\)\([0-9][0-9]\)\([0-9][0-9]\)-\([0-9][0-9]\)\([0-9][0-9]\)\([0-9][0-9]\)/\([^/]*\),\1-\2-\3 \4:\5:\6  \7,'
}
stamp() {
	sed -e 's,.*/\([0-9][0-9][0-9][0-9]\)\([0-9][0-9]\)\([0-9][0-9]\)-\([0-9][0-9]\)\([0-9][0-9]\)\([0-9][0-9]\)/\([^/]*\),\1-\2-\3 \4:\5:\6  \7  &,'
}
list-submissions() {
	[ -d "$submissions" ] && find $submissions -name "*.*" | sort -r
}
list-results() {
	[ -d "$results" ]     && find $results     -name "*.*" | stamp | sort -r | sed -e "s/^.*  //"
}
[ -n "$user" ] || errxit "missing <user> argument"
[ -d "$USERS_DIR/$user" ] || errxit "user not found"
[ -d "$submissions" ] && find $submissions -name "*.*" | format | sed -e "s/$/  -  pending/"
for filename in `list-results | head -5`
do
	echo -n $filename | format
	echo -n "  "
	result="`dirname $filename`/result"
	tail -1 "$result" | tr -d '\n'
	echo -n "  "
	tail -2 "$result" | head -1
done
